# cpp.znone / Regions 动态 CRUD 查询接入 - 多 Agent 执行计划

目标：
- 基于 DynamicCrudService 实现 Regions（行政区划）查询
- 仅支持 parent_id + keywords
- keywords 模糊匹配字段：postal_code、area_code、region_name、name_pinyin、short_name
- 在 api.boss / api.doctor / api.patient 三个项目暴露 GET /api/regions
- 输出统一错误格式（依赖全局异常处理器），成功返回 JSON 列表

---

## Agent-01：Schema 修正与实体/DTO准备

### 输入
- 当前 regions 建表 SQL（含错误字段 ` `）
- 项目现有 ORM 方式（JPA/MyBatis 任选其一，按现有项目一致）

### 任务
1. 修正表字段：将空字段名替换为 short_name
2. 创建/确认 Entity：Region（字段映射到 regions 表）
3. 创建 DTO：RegionDto（对外传输字段）
4. 建议只读：DTO 可只包含前端需要字段（至少 id, parentId, regionLevel, postalCode, areaCode, regionName, namePinyin, shortName, mergeName, longitude, latitude）

### 验收
- 项目能编译
- Entity/DTO 可被引用

---

## Agent-02：Query/Criteria 规范化（只允许 parent_id + keywords）

### 任务
1. 在 core.application 的 dto/query 目录新增 RegionQuery：
   - 字段：Long parentId, String keywords, Integer limit, Integer offset
   - 实现/继承 BaseQuery，确保 toMap() 输出：
     - parent_id -> parentId (若不为空)
     - keywords -> keywords (若不为空且非空串)
2. 增加参数约束（可选）：
   - limit 默认 50，最大 200
   - offset 默认 0
3. 不允许 Controller 拼 SQL / 拼 OR 条件，全部交给 DynamicRepository

### 验收
- RegionQuery.toMap() 输出符合约定
- 任何新逻辑不污染其它 Query

---

## Agent-03：注册 CrudConfig（regions）并挂到 DynamicCrudConfigRegistry

### 任务
1. 在 core.application 或 core.infrastructure（按你项目的装配约定）创建配置类：
   - RegionCrudConfigRegistrar（@Configuration 或 @Component）
2. 在启动时调用 configRegistry.register("regions", CrudConfig...)
3. CrudConfig 内容建议：
   - name = "regions"
   - title = "行政区划"
   - entityType = Region.class
   - dtoType = RegionDto.class
   - publishEvents = false（只读查询，不需要事件）
   - softDelete = false
   - enableSearchCache 可按需（建议 true, TTL 60）
   - entityToDto 可用 ModelMapper 或自定义 converter

### 验收
- 应用启动不报 CrudConfig not found
- DynamicCrudService.search("regions", ...) 能返回 RegionDto 列表

---

## Agent-04：DynamicRepository 支持 keywords 扩展（若尚未支持）

### 仅当当前 DynamicRepository 不支持 keywords 才做
1. 当 criteria 包含 "keywords"：
   - 取 kw = criteria.get("keywords")
   - 生成 OR 条件：
     postal_code LIKE %kw%
     OR area_code LIKE %kw%
     OR region_name LIKE %kw%
     OR name_pinyin LIKE %kw%
     OR short_name LIKE %kw%
2. parent_id 仍然为 AND 精确匹配
3. limit/offset 生效

### 验收
- 传 keywords="shang" 能命中 name_pinyin / region_name
- 传 keywords="010" 能命中 area_code
- 传 parent_id=xxxx 只返回该父级下的项

---

## Agent-05：三端 Controller 接入（boss / doctor / patient）

目标：三个项目都提供 GET /api/regions

### 文件路径要求（按用户指定）
1. api.boss:
   - src/server/api.boss/src/main/java/com/mayanshe/nosocomiumonline/boss/controller/RegionController.java
2. api.doctor:
   - src/server/api.doctor/src/main/java/com/mayanshe/nosocomiumonline/doctor/controller/MediaController.java
3. api.patient:
   - src/server/api.patient/src/main/java/com/mayanshe/nosocomiumonline/patient/controller/MediaController.java

### 任务
1. boss 新建 RegionController（如果已存在则新增方法）
2. doctor/patient 在 MediaController 内新增方法（保持现有类不动）
3. 三个方法逻辑一致：
   - 读取 parentId/keywords/limit/offset
   - 构造 RegionQuery（或直接 Map criteria）
   - 调用 dynamicCrudService.search("regions", criteria, limit, offset)
4. 不在 Controller 内处理异常格式；异常交给全局异常处理器

### 验收
- 三个服务都能启动
- GET /api/regions?parentId=0&keywords=北京 返回一致结构
- limit/offset 生效

---

## Agent-06：最小集成测试（可选但强烈建议）

### 任务
1. core.application 加一个测试：DynamicCrudService.search regions
2. api.boss 加一个 MockMvc 测试：GET /api/regions
3. 验证响应码 200 + JSON 数组
4. 验证 parentId 过滤与 keywords 模糊查询

### 验收
- CI 可跑通
- 回归不破坏其它 CRUD

---
